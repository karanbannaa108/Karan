<!doctype html>
<html>
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Manage Bots</title>
<style>body{font-family:Arial;background:#071427;color:#fff;padding:20px}.card{max-width:1000px;margin:12px auto;background:#0b1723;padding:16px;border-radius:8px}table{width:100%;border-collapse:collapse}th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.04)}button{padding:6px 10px;border-radius:6px;border:0;background:#7b2eff;color:#fff;cursor:pointer}</style>
</head>
<body>
<div class="card">
  <h2>Your Bots</h2>
  <table id="bots"><thead><tr><th>Name</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table>
</div>

<div class="card" id="logsCard" style="display:none">
  <h3>Logs for <span id="logsName"></span></h3>
  <pre id="logsArea" style="height:300px;overflow:auto;background:#041225;padding:10px;border-radius:6px"></pre>
  <button id="closeLogs">Close</button>
</div>

<script>
const BASE = window.BASE_API || '';

async function api(path, opts={}) {
  opts.credentials='include';
  if (opts.body && typeof opts.body === 'object') {
    opts.body = JSON.stringify(opts.body);
    opts.headers = opts.headers || {};
    opts.headers['Content-Type']='application/json';
  }
  const r = await fetch(BASE + path, opts);
  if (!r.ok) throw new Error('Error ' + r.status);
  return r.json();
}

async function load() {
  try {
    const bots = await api('/bots');
    const tbody = document.querySelector('#bots tbody');
    tbody.innerHTML='';
    bots.forEach(b=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${b.name || b.id}</td><td>${b.status || 'unknown'}</td><td>
        <button class="start" data-id="${b.id}">Start</button>
        <button class="stop" data-id="${b.id}">Stop</button>
        <button class="logs" data-id="${b.id}" data-name="${b.name||b.id}">Logs</button>
        <button class="del" data-id="${b.id}">Delete</button>
      </td>`;
      tbody.appendChild(tr);
    });
  } catch(e) {
    alert('Load failed: ' + e.message);
  }
}

document.addEventListener('click', async (ev)=>{
  const t=ev.target;
  try {
    if (t.matches('.start')) {
      await api('/bots/' + t.dataset.id + '/start', { method:'POST' }); load();
    } else if (t.matches('.stop')) {
      await api('/bots/' + t.dataset.id + '/stop', { method:'POST' }); load();
    } else if (t.matches('.logs')) {
      const id = t.dataset.id, name = t.dataset.name;
      document.getElementById('logsCard').style.display='block';
      document.getElementById('logsName').innerText = name;
      const lines = await api('/bots/' + id + '/logs');
      document.getElementById('logsArea').innerText = lines.map(l => new Date(l.at).toLocaleTimeString() + ' ' + l.msg).join('\n');
    } else if (t.matches('.del')) {
      if (!confirm('Delete bot?')) return;
      await api('/bots/' + t.dataset.id, { method:'DELETE' }); load();
    }
  } catch(e){ alert('Action failed: ' + e.message); }
});

document.getElementById('closeLogs').onclick = ()=> document.getElementById('logsCard').style.display='none';

load();
</script>
</body>
</html>
